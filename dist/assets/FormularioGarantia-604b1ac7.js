import{c as $,j as a,r as n,A as R,a as k,d as P,h as C,i as A,k as B,l as M,D as T,s as G,b as U,L as F,I as q,B as z,g as K}from"./index-a97f1121.js";import{S as J,a as O,b as Q,c as W,d as D}from"./select-c7f8521e.js";const H=$([a.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),a.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]),X=({label:v,onUploadSuccess:u,sessionId:p,documentType:r})=>{const[d,h]=n.useState(null),[x,b]=n.useState(!1),[_,o]=n.useState(""),[N,l]=n.useState(""),S=f=>{const c=f.target.files[0];if(c){if(!c.type.startsWith("image/")){l("Error: Solo se permiten archivos de imagen (JPG, PNG, etc.).");return}if(c.size>5*1024*1024){l("Error: El archivo no puede superar los 5MB.");return}h(c),l(""),o("")}},j=async()=>{if(!d||!p){l("No hay un archivo seleccionado o falta el ID de sesión.");return}b(!0),l("");const f=d.name.split(".").pop(),c=`${p}/${r}_${Date.now()}.${f}`;try{const{error:g}=await G.storage.from("documentos").upload(c,d);if(g)throw g;const{data:{publicUrl:w}}=G.storage.from("documentos").getPublicUrl(c);o(w),u&&u(w,r)}catch(g){l(`Fallo la subida: ${g.message}`)}finally{b(!1)}},y=()=>{h(null),o(""),l(""),u&&u("",r)};return a.jsxs("div",{className:"bg-card text-card-foreground rounded-lg border p-4 shadow-sm",children:[a.jsx("p",{className:"text-sm font-medium mb-1",children:v}),N&&a.jsxs(R,{variant:"destructive",className:"mb-2",children:[a.jsx(k,{className:"h-4 w-4"}),a.jsx(P,{children:N})]}),_?a.jsxs("div",{className:"flex items-center text-success",children:[a.jsx(B,{className:"mr-1"}),a.jsx("p",{className:"text-sm flex-1",children:"¡Imagen subida con éxito!"}),a.jsx(M,{onClick:y,size:"small",children:a.jsx(T,{})})]}):a.jsxs(a.Fragment,{children:[a.jsxs(C,{component:"label",variant:"outlined",fullWidth:!0,startIcon:a.jsx(H,{}),disabled:x,sx:{mb:1},children:["Seleccionar Imagen",a.jsx("input",{type:"file",hidden:!0,accept:"image/jpeg,image/png,image/jpg",onChange:S})]}),a.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Formatos permitidos: JPG, PNG (máximo 5MB)"}),d&&a.jsxs("div",{className:"mt-2",children:[a.jsxs("p",{className:"text-sm",children:["Archivo: ",d.name]}),a.jsx(C,{onClick:j,variant:"contained",sx:{mt:1},disabled:x,children:x?"Subiendo...":"Subir Imagen"})]}),x&&a.jsx(A,{sx:{mt:2}})]})]})},ea=({sessionId:v,onStepComplete:u,onProgressUpdate:p})=>{const[r,d]=n.useState({descripcion_garantia:"",valor_garantia:"",tipo_garantia:""}),[h,x]=n.useState([]),[b,_]=n.useState(!1),[o,N]=n.useState({}),[l,S]=n.useState(""),j=n.useRef(null),y=n.useRef(null),f=n.useRef(null),c=[j,y,f];n.useEffect(()=>{var e;(e=j.current)==null||e.focus()},[]),n.useEffect(()=>{typeof p=="function"&&p({currentQuestion:1,totalQuestions:4})},[p]);const g=e=>{const{name:i,value:t}=e.target;d(s=>({...s,[i]:t}))},w=(e,i,t={})=>{const s="foto_garantia";x(m=>[...m.filter(V=>V.tipo_documento!==s),{tipo_documento:s,url_storage:e||"",nombre_archivo:t.nombre_archivo||"",tamaño_archivo:t.tamaño_archivo||0,tipo_mime:t.tipo_mime||"image/*",storage_path:t.storage_path||""}])},L=()=>{const e={},i=String(r.descripcion_garantia||"").trim();i?i.length<10&&(e.descripcion_garantia="La descripción debe tener al menos 10 caracteres"):e.descripcion_garantia="La descripción de la garantía es obligatoria";const t=String(r.valor_garantia||"").trim(),s=parseFloat(t);return t?(Number.isNaN(s)||s<=0)&&(e.valor_garantia="Debe ser un número mayor que 0"):e.valor_garantia="El valor de la garantía es obligatorio",String(r.tipo_garantia||"").trim()||(e.tipo_garantia="El tipo de garantía es obligatorio"),N(e),Object.keys(e).length===0},I=async e=>{var i;if(e&&typeof e.preventDefault=="function"&&e.preventDefault(),S(""),!!L()){_(!0);try{const t={descripcion_garantia:String(r.descripcion_garantia||"").trim(),valor_estimado_garantia:parseFloat(r.valor_garantia),tipo_garantia:String(r.tipo_garantia||"").trim(),url_foto_garantia:h.length>0&&((i=h[0])==null?void 0:i.url_storage)||""},s=await fetch("/api/orchestrator",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"submit_form_step",sessionId:v,payload:{currentStep:6,stepData:t}})}),m=await s.json();if(!s.ok||m.success===!1)throw new Error(m.error||"Error al enviar la información de la garantía");u&&u(7)}catch(t){S(t.message||"Error de conexión. Por favor, intente nuevamente.")}finally{_(!1)}}},E=(e,i)=>{var t;if(e.key==="Enter"){if(i===2&&!String(r.tipo_garantia||"").trim())return;e.preventDefault();for(let s=i+1;s<c.length;s++){const m=(t=c[s])==null?void 0:t.current;if(m){m.focus();return}}I()}};return a.jsxs("form",{onSubmit:I,className:"max-w-[600px] mx-auto p-3",children:[a.jsx("h1",{className:"text-3xl sm:text-4xl font-bold tracking-tight text-foreground",children:"Paso 6: Garantía Mobiliaria"}),a.jsx("p",{className:"text-muted-foreground mb-6",children:"Registre la información de la garantía que respalda su solicitud de crédito."}),l&&a.jsxs(R,{variant:"destructive",className:"mb-6",children:[a.jsx(k,{className:"h-4 w-4"}),a.jsx(U,{children:"Error"}),a.jsx(P,{children:l})]}),a.jsxs("div",{className:"mt-12",children:[a.jsx("h3",{className:"text-xl font-semibold border-b pb-2 mb-6",children:"Información de la Garantía"}),a.jsxs("div",{className:"mb-6",children:[a.jsx(X,{label:"Foto de la Garantía (opcional)",onUploadSuccess:w,sessionId:v,documentType:"foto_garantia"}),a.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Puedes adjuntar una foto para facilitar la verificación (opcional)."})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx(F,{htmlFor:"descripcion_garantia",children:"Descripción de la Garantía"}),a.jsx("textarea",{id:"descripcion_garantia",name:"descripcion_garantia",value:r.descripcion_garantia,onChange:g,ref:j,onKeyDown:e=>E(e,0),placeholder:"Describa detalladamente la garantía (marca, modelo, características, estado, etc.)",rows:4,className:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm"}),o.descripcion_garantia&&a.jsx("p",{className:"text-xs text-destructive mt-1",children:o.descripcion_garantia})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx(F,{htmlFor:"valor_garantia",children:"Valor de la Garantía"}),a.jsxs("div",{className:"relative",children:[a.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground",children:"$"}),a.jsx(q,{id:"valor_garantia",type:"number",name:"valor_garantia",value:r.valor_garantia,onChange:g,ref:y,onKeyDown:e=>E(e,1),placeholder:"Ingrese el valor de la garantía",min:0,step:.01,className:"pl-7"})]}),o.valor_garantia&&a.jsx("p",{className:"text-xs text-destructive mt-1",children:o.valor_garantia})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx(F,{htmlFor:"tipo_garantia",children:"Tipo de Garantía"}),a.jsxs(J,{value:r.tipo_garantia,onValueChange:e=>d(i=>({...i,tipo_garantia:e})),children:[a.jsx(O,{ref:f,onKeyDown:e=>E(e,2),className:"w-full",children:a.jsx(Q,{placeholder:"Seleccione el tipo de garantía"})}),a.jsxs(W,{children:[a.jsx(D,{value:"Vehículo",children:"Vehículo"}),a.jsx(D,{value:"Inmueble",children:"Inmueble"}),a.jsx(D,{value:"Maquinaria",children:"Maquinaria"})]})]}),o.tipo_garantia&&a.jsx("p",{className:"text-xs text-destructive mt-1",children:o.tipo_garantia})]})]}),a.jsx("div",{className:"flex justify-center mt-12",children:a.jsx(z,{type:"submit",size:"lg",disabled:b,className:"min-w-[200px] font-semibold",children:b?a.jsxs(a.Fragment,{children:[a.jsx(K,{className:"mr-2 w-5 h-5"}),"Guardando..."]}):"Continuar al Resumen"})})]})};export{ea as default};
