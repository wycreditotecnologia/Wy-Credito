import{c as B,j as e,r as i,f as U,L as j,I as E,e as K,F as w,A as W,a as G,b as J,d as Q,B as q,g as V}from"./index-a97f1121.js";import{S as H,a as X,b as Y,c as Z,d as A}from"./select-c7f8521e.js";const ee=B(e.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"}));async function te(u,c,F){console.log(`Iniciando extracción con IA (backend) para el archivo: ${u}`);try{let a="application/pdf";if(c&&c.includes("/"))a=c;else if(typeof u=="string"){const r=u.toLowerCase();r.endsWith(".png")?a="image/png":r.endsWith(".jpg")||r.endsWith(".jpeg")?a="image/jpeg":r.endsWith(".pdf")&&(a="application/pdf")}const d=await fetch("/api/gemini-extract",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileUrl:u,fileType:a,tipo_documento:F})});if(!d.ok){const r=await d.text().catch(()=>"");throw new Error(`Error del backend (${d.status}): ${r}`)}const x=await d.json(),h=(x==null?void 0:x.data)||{};return console.log("Datos extraídos por Gemini (backend):",h),h}catch(a){return console.error("Error en la extracción con Gemini (backend):",a),{}}}const ne=({onStepComplete:u,sessionId:c,onProgressUpdate:F})=>{const[a,d]=i.useState({nombre_representante_legal:"",documento_representante_legal:"",celular_representante_legal:"",tipo_documento_rl:"",url_doc_identidad:"",url_certificado_existencia:"",url_composicion_accionaria:""}),[x,h]=i.useState([]),[r,O]=i.useState({}),[R,T]=i.useState(!1),[P,z]=i.useState(""),[m,b]=i.useState({extracting:!1,error:"",nit:"",razon:""}),v=i.useRef(null),N=i.useRef(null),S=i.useRef(null),y=i.useRef(null),k=[v,N,S,y],M=t=>{const o=k.findIndex(s=>s===t),n=k[o+1];n&&n.current?n.current.focus():I()},C=t=>{const{name:o}=t.target;let{value:n}=t.target;(o==="documento_representante_legal"||o==="celular_representante_legal")&&(n=n.replace(/\D/g,"")),d(s=>({...s,[o]:n}))},g=(t,o)=>{t.key==="Enter"&&(t.preventDefault(),M(o))},$={url_doc_identidad:"identidad_rl",url_certificado_existencia:"certificado_existencia",url_composicion_accionaria:"composicion_accionaria"},D=async(t,o,n={})=>{d(p=>({...p,[o]:t}));const s=$[o]||o;if(h(p=>[...p.filter(_=>_.tipo_documento!==s),{tipo_documento:s,nombre_archivo:n.nombre_archivo||"",url_storage:t,tamaño_archivo:n.tamaño_archivo||0,tipo_mime:n.tipo_mime||"application/pdf"}]),o==="url_certificado_existencia")try{b({extracting:!0,error:"",nit:"",razon:""});const p=(n==null?void 0:n.tipo_mime)||void 0,l=await te(t,p,"certificado_existencia"),_=((l==null?void 0:l.nit)||"").toString().trim(),f=((l==null?void 0:l.razon_social)||(l==null?void 0:l.razonSocial)||"").toString().trim();try{_&&localStorage.setItem(`pre_nit_${c}`,_),f&&localStorage.setItem(`pre_razon_social_${c}`,f)}catch{}try{fetch("/api/orchestrator",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"log",data:{solicitud_id:c,accion:"ai_extract_certificado",estado_anterior:null,estado_nuevo:null,datos_validados:{nit:_,razon_social:f},errores:null}})}).catch(()=>{})}catch{}b({extracting:!1,error:"",nit:_,razon:f})}catch{b({extracting:!1,error:"No fue posible extraer datos del certificado.",nit:"",razon:""})}},L=()=>{const t={};a.nombre_representante_legal.trim()||(t.nombre_representante_legal="El nombre del representante es obligatorio"),a.documento_representante_legal.trim()||(t.documento_representante_legal="El número de documento es obligatorio"),a.celular_representante_legal.trim()||(t.celular_representante_legal="El celular del representante es obligatorio"),a.tipo_documento_rl||(t.tipo_documento_rl="Debe seleccionar el tipo de documento del representante legal");const o=["identidad_rl","certificado_existencia","composicion_accionaria"],n=new Set(x.map(s=>s.tipo_documento));return o.forEach(s=>{if(!n.has(s))if(s==="identidad_rl"){const p=a.tipo_documento_rl||"CC/CE";t[s]=`Debe subir el documento de identidad del representante legal (${p}) en PDF.`}else s==="certificado_existencia"?t[s]="Debe subir el certificado de existencia y representación legal vigente en PDF.":s==="composicion_accionaria"&&(t[s]="Debe subir la composición accionaria con listado de accionistas y porcentajes en PDF.")}),O(t),Object.keys(t).length===0},I=async()=>{if(L()){T(!0),z("");try{const t={nombre_representante_legal:a.nombre_representante_legal,documento_representante_legal:a.documento_representante_legal,celular_representante_legal:a.celular_representante_legal,tipo_documento_rl:a.tipo_documento_rl,url_doc_identidad:a.url_doc_identidad,url_certificado_existencia:a.url_certificado_existencia,url_composicion_accionaria:a.url_composicion_accionaria},n=await(await fetch("/api/orchestrator",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"submit_form_step",sessionId:c,payload:{currentStep:3,stepData:t}})})).json();if(!n.success)throw new Error(n.error||"Error desconocido del servidor.");u(3)}catch(t){z(t.message)}finally{T(!1)}}};return e.jsxs("div",{className:"max-w-[800px] mx-auto",children:[e.jsxs("div",{className:"mt-12",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{className:"mr-2 text-primary"}),e.jsx("h3",{className:"text-xl font-semibold border-b pb-2 mb-6",children:"Datos del Representante Legal"})]}),e.jsx(U,{className:"my-8"}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12",children:e.jsxs("div",{className:"mb-6",children:[e.jsx(j,{htmlFor:"nombre_representante_legal",children:"Nombre Completo"}),e.jsx(E,{id:"nombre_representante_legal",name:"nombre_representante_legal",ref:v,value:a.nombre_representante_legal,onChange:C,onKeyDown:t=>g(t,v)}),r.nombre_representante_legal&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.nombre_representante_legal})]})}),e.jsx("div",{className:"col-span-12 md:col-span-6",children:e.jsxs("div",{className:"mb-6",children:[e.jsx(j,{htmlFor:"documento_representante_legal",children:"Número de cédula del representante legal"}),e.jsx(E,{id:"documento_representante_legal",name:"documento_representante_legal",ref:N,inputMode:"numeric",pattern:"[0-9]*",placeholder:"Solo números",value:a.documento_representante_legal,onChange:C,onKeyDown:t=>g(t,N)}),r.documento_representante_legal&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.documento_representante_legal})]})}),e.jsx("div",{className:"col-span-12 md:col-span-6",children:e.jsxs("div",{className:"mb-6",children:[e.jsx(j,{htmlFor:"celular_representante_legal",children:"Número de Celular"}),e.jsx(E,{id:"celular_representante_legal",name:"celular_representante_legal",ref:S,inputMode:"numeric",pattern:"[0-9]*",placeholder:"Solo números",value:a.celular_representante_legal,onChange:C,onKeyDown:t=>g(t,S)}),r.celular_representante_legal&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.celular_representante_legal})]})}),e.jsx("div",{className:"col-span-12 md:col-span-6",children:e.jsxs("div",{className:"mb-6",children:[e.jsx(j,{htmlFor:"tipo_documento_rl",children:"¿Qué tipo de documento del representante legal vas a subir?"}),e.jsxs(H,{value:a.tipo_documento_rl,onValueChange:t=>d(o=>({...o,tipo_documento_rl:t})),children:[e.jsx(X,{id:"tipo_documento_rl",className:"w-full",ref:y,onKeyDown:t=>g(t,y),children:e.jsx(Y,{placeholder:"Selecciona el tipo de documento"})}),e.jsxs(Z,{children:[e.jsx(A,{value:"CC",children:"Cédula de Ciudadanía (CC)"}),e.jsx(A,{value:"CE",children:"Cédula de Extranjería (CE)"})]})]}),r.tipo_documento_rl&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.tipo_documento_rl})]})})]})]}),e.jsxs("div",{className:"mt-12",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(K,{className:"mr-2 text-primary"}),e.jsx("h3",{className:"text-xl font-semibold border-b pb-2 mb-6",children:"Documentos Requeridos"})]}),e.jsx(U,{className:"my-8"}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"mb-6",children:e.jsx(w,{label:"Documento de Identidad del Representante Legal",sessionId:c,documentType:"url_doc_identidad",onUploadSuccess:D,helperText:`PDF ≤ 10MB. Debe coincidir con el tipo seleccionado (${a.tipo_documento_rl||"CC/CE"}).`})}),r.identidad_rl&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.identidad_rl})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"mb-2",children:e.jsx(w,{label:"Certificado de Existencia y Representación",sessionId:c,documentType:"url_certificado_existencia",onUploadSuccess:D,helperText:"PDF ≤ 10MB. Certificado vigente de Cámara de Comercio."})}),m.extracting&&e.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"Extrayendo datos de NIT y Razón Social…"}),!m.extracting&&(m.nit||m.razon)&&e.jsxs("p",{className:"text-xs text-green-700 mb-4",children:["Extraído: NIT ",m.nit||"—"," • Razón Social ",m.razon||"—"," (puede editarse en Información Empresarial)"]}),m.error&&e.jsx("p",{className:"text-xs text-destructive mb-4",children:m.error}),r.certificado_existencia&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.certificado_existencia})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"mb-6",children:e.jsx(w,{label:"Documento de Composición Accionaria",sessionId:c,documentType:"url_composicion_accionaria",onUploadSuccess:D,helperText:"PDF ≤ 10MB. Detalle de socios y porcentajes."})}),r.composicion_accionaria&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:r.composicion_accionaria})]})]})]}),P&&e.jsxs(W,{variant:"destructive",className:"mb-6",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsx(J,{children:"Error"}),e.jsx(Q,{children:P})]}),e.jsx("div",{className:"flex justify-end mt-12",children:e.jsx(q,{onClick:I,disabled:R,className:"bg-black text-white hover:bg-black/80",children:R?e.jsx(V,{className:"w-6 h-6"}):"Guardar y Continuar"})})]})};i.useEffect(()=>{typeof onProgressUpdate=="function"&&onProgressUpdate({currentQuestion:1,totalQuestions:4})},[onProgressUpdate]);export{ne as default};
